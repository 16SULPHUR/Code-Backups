import { getFileBuffer, getFormattedDateTime } from "./helpers";
import axios from "axios";

export async function uploadToGithub(files, folderName) {
  const token = process.env.REACT_APP_GITHUB_TOKEN;
  const filesWithBuffer = await Promise.all(
    files.map(async (file) => ({
      file,
      buffer: await getFileBuffer(file),
    }))
  );
  const basePath = getFormattedDateTime(folderName || "");

  try {
    // Get the current tree
    const treeResponse = await axios({
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      method: "get",
      url: "https://api.github.com/repos/16SULPHUR/Code-Backups/git/trees/main",
    });

    const currentTree = treeResponse.data.tree;

    // Create blobs and prepare new tree entries
    const newTreeEntries = [];

    for (const { file, buffer } of filesWithBuffer) {
      const relativePath = file.meta.relativePath || file.data.name;
      const path = `${basePath}/${relativePath}`;

      // Create a blob for the file
      const blobResponse = await axios({
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
        method: "post",
        url: "https://api.github.com/repos/16SULPHUR/Code-Backups/git/blobs",
        data: {
          content: buffer,
          encoding: "base64",
        },
      });

      const blobSHA = blobResponse.data.sha;

      // Add the new file entry to the new tree
      newTreeEntries.push({
        path: path,
        mode: "100644",
        type: "blob",
        sha: blobSHA,
      });
    }

    // Combine current tree and new tree entries
    const combinedTree = currentTree
      .map((item) => ({
        path: item.path,
        mode: item.mode,
        type: item.type,
        sha: item.sha,
      }))
      .concat(newTreeEntries);

    // Create a new tree
    const newTreeResponse = await axios({
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      method: "post",
      url: "https://api.github.com/repos/16SULPHUR/Code-Backups/git/trees",
      data: { tree: combinedTree },
    });

    const newTreeSHA = newTreeResponse.data.sha;

    // Get the parent commit
    const parentResponse = await axios({
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      url: "https://api.github.com/repos/16SULPHUR/Code-Backups/git/refs/heads/main",
      method: "get",
    });

    const parentSHA = parentResponse.data.object.sha;

    // Create a new commit
    const commitResponse = await axios({
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      method: "post",
      url: "https://api.github.com/repos/16SULPHUR/Code-Backups/git/commits",
      data: {
        message: `Add files in folder ${basePath}`,
        tree: newTreeSHA,
        parents: [parentSHA],
      },
    });

    const commitSHA = commitResponse.data.sha;

    // Update the reference to point to the new commit
    await axios({
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      method: "patch",
      url: "https://api.github.com/repos/16SULPHUR/Code-Backups/git/refs/heads/main",
      data: {
        sha: commitSHA,
      },
    });

    console.log("Files uploaded successfully");
    return true
  } catch (error) {
    console.error("Error uploading files:", error);
  }
}
